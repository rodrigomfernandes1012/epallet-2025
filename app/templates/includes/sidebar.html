<aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 bg-white" id="sidenav-main">
    <div class="sidenav-header">
        <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
        <a class="navbar-brand m-0" href="{{ url_for('main.dashboard') }}">
            <span class="ms-1 font-weight-bold">Sistema de Gestão Epallet</span>
        </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main" style="display: flex !important; flex-direction: column !important; height: calc(100vh - 120px) !important;">
        <ul class="navbar-nav" style="flex: 1 !important; overflow-y: auto !important; padding-bottom: 20px;">
            
            {# Dashboard - Sempre visível #}
            {% if current_user.tem_permissao('dashboard', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}" href="{{ url_for('main.dashboard') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-home text-primary text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Dashboard</span>
                </a>
            </li>
            {% endif %}
            
            {# Seção Cadastros #}
            {% set tem_cadastros = current_user.tem_permissao('empresas', 'visualizar') or 
                                   current_user.tem_permissao('tipos_empresa', 'visualizar') or 
                                   current_user.tem_permissao('motoristas', 'visualizar') %}
            
            {% if tem_cadastros or not current_user.perfil_id %}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Cadastros</h6>
            </li>
            
            {% if current_user.tem_permissao('empresas', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'empresas' in request.endpoint %}active{% endif %}" href="{{ url_for('empresas.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-building text-warning text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Empresas</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('tipos_empresa', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'tipos_empresa' in request.endpoint %}active{% endif %}" href="{{ url_for('tipos_empresa.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-tags text-info text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Tipos de Empresa</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('motoristas', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'motoristas' in request.endpoint %}active{% endif %}" href="{{ url_for('motoristas.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-id-card text-secondary text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Motoristas</span>
                </a>
            </li>
            {% endif %}
            {% endif %}
            
            {# Seção Operações #}
            {% set tem_operacoes = current_user.tem_permissao('vale_pallet', 'visualizar') or 
                                   current_user.tem_permissao('devolucao_pallet', 'visualizar') %}
            
            {% if tem_operacoes or not current_user.perfil_id %}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Operações</h6>
            </li>
            
            {% if current_user.tem_permissao('vale_pallet', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'vale_pallet' in request.endpoint %}active{% endif %}" href="{{ url_for('vale_pallet.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-pallet text-success text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Vale Pallet</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('devolucao_pallet', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'devolucao_pallet' in request.endpoint and 'validar_pin' not in request.endpoint %}active{% endif %}" href="{{ url_for('devolucao_pallet.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-undo text-primary text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Devoluções de Pallets</span>
                </a>
            </li>
            {% endif %}
            {% endif %}
            
            {# Confirmação de Recebimento - Autenticado #}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'confirmacao' in request.endpoint %}active{% endif %}" href="{{ url_for('confirmacao.index') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-clipboard-check text-warning text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Confirmar Recebimento</span>
                </a>
            </li>
            
            {# Seção Acesso Público - Apenas validações de PIN #}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Acesso Público</h6>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('publico.validacao_pin') }}" target="_blank">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-key text-info text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Validar PIN (Envio)</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('devolucao_pallet.validar_pin') }}" target="_blank">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-truck-loading text-success text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Validar PIN (Devolução)</span>
                </a>
            </li>
            
            {# Seção Sistema #}
            {% set tem_sistema = current_user.tem_permissao('logs', 'visualizar') or 
                                 current_user.tem_permissao('relatorios', 'visualizar') %}
            
            {% if tem_sistema or not current_user.perfil_id %}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Sistema</h6>
            </li>
            
            {% if current_user.tem_permissao('logs', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'logs.listar' %}active{% endif %}" href="{{ url_for('logs.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-history text-info text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Logs de Auditoria</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('relatorios', 'visualizar') or not current_user.perfil_id %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'relatorios.movimentacao' %}active{% endif %}" href="{{ url_for('relatorios.movimentacao') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-chart-bar text-success text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Relatórios</span>
                </a>
            </li>
            {% endif %}
            {% endif %}
            
            {# Seção Administração #}
            {% set tem_admin = current_user.tem_permissao('usuarios', 'visualizar') or 
                               current_user.tem_permissao('perfis', 'visualizar') or 
                               current_user.tem_permissao('emails', 'visualizar') %}
            
            {% if tem_admin %}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Administração</h6>
            </li>
            
            {% if current_user.tem_permissao('usuarios', 'visualizar') %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'usuarios' in request.endpoint %}active{% endif %}" href="{{ url_for('usuarios.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-users text-primary text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Usuários</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('perfis', 'visualizar') %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'perfis' in request.endpoint %}active{% endif %}" href="{{ url_for('perfis.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-user-shield text-warning text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Perfis</span>
                </a>
            </li>
            {% endif %}
            
            {% if current_user.tem_permissao('emails', 'visualizar') %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint and 'emails' in request.endpoint %}active{% endif %}" href="{{ url_for('emails.listar') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-envelope text-info text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Emails Enviados</span>
                </a>
            </li>
            {% endif %}
            {% endif %}
            
            {# Seção Conta - Sempre visível #}
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Conta</h6>
            </li>
            
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.profile' %}active{% endif %}" href="{{ url_for('main.profile') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-user text-dark text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Perfil</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('usuarios.alterar_senha') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-lock text-secondary text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Alterar Senha</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-sign-out-alt text-danger text-sm opacity-10"></i>
                    </div>
                    <span class="nav-link-text ms-1">Sair</span>
                </a>
            </li>
        </ul>
    </div>
</aside>
